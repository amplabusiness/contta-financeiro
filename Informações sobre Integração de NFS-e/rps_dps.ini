RPS/DPS

O que é RPS e DPS?

A sigla RPS significa Recibo Provisório de Serviço.

Diferente do processo de emissão de outros DFes, onde é gerado o XML do respectivo DFe e o mesmo é enviado para validação e aceitação do web service, na emissão de Nota Fiscal de Serviço(NFSe), é o web service quem gera o XML da NFSe.

Ou seja:

image.png

No caso do Padrão Nacional, é chamado de "Declaração de Prestação de Serviço" (DPS).

E apesar da diferença no nome, sua função e lógica é basicamente a mesma do RPS, ou seja, o prestador gera um XML de DPS, envia o mesmo para a API do Padrão Nacional e em caso de sucesso, o DPS é convertido em NFSe e o XML da mesma é devolvido para o prestador.

Por que não existe quando emito direto pela prefeitura?

O RPS só faz parte do processo de emissão quando o mesmo é feito através de um web service.

Quando a emissão é feita pelo site da prefeitura(quando existe a opção), o RPS é inexistente.

É importante entender que o processo de emissão para NFSe é diferente quando feito através do site da prefeitura e quando feito via web service.

Muitas vezes, são usuários diferentes para o site e para o web service, existindo casos em que mesmo no web service os usuários dos ambientes de homologação e produção são diferentes.

PROVEDORES

O que é um provedor?

Provedor é nome dado as empresas que fornecem o web service com o serviço de emissão de nota para as administrações municipais.

Diferente de outros DFes, a nota de serviço tem sua tributação em nível municipal. Por isso, não há, por exemplo, uma Sefaz para cuidar dos serviços de emissão.

Para se ter uma ideia, já passamos da marca de 130 provedores implementados na solução de emissão de nota de serviço do ACBr.

Leiaute ABRASF e Leiaute do próprio?

Devido ao fato de ser algo a nível municipal, não há uma padronização de leiaute na formação dos arquivos XML de RPS e de NFSe.

O leiaute ABRASF foi uma sugestão de padronização feita pela entidade no início do projeto da Nota de Serviço.

Alguns provedores implementaram seus web services seguindo tal padrão, no entanto, ainda assim existem provedores que apesar de seguir o leiaute, implementaram particularidades próprias.

Há também provedores que não seguiram a sugestão e criaram um leiaute próprio completamente diferente.

Temos provedores em que é possível enviar um lote de até 50 RPS e temos provedores em que o envio é unitário.

É importante lembrar que apesar desta falta de padronização por parte dos provedores no que diz respeito a implementação da emissão de NFSe, as soluções ACBr procuram abstrair ao máximo essas particularidades, simplificando o processo de emissão da melhor forma possível.

HOMOLOGAÇÃO

Como saber se minha cidade é atendida?

Para verificar se sua cidade é atendida basta buscar pela mesma no arquivo ACBrNFSeXServicos.ini que acompanha todas as soluções de emissão de Nota de Serviço do ACBr.

Caso haja informação de provedor atribuída, é possível realizar emissão para a mesma.

Vejam um exemplo:

[3550308]
Nome=Sao Paulo
UF=SP
Provedor=ISSSaoPaulo
ProRecepcionar=https://nfe.prefeitura.sp.gov.br/ws/lotenfe.asmx
ProLinkURL=https://nfe.prefeitura.sp.gov.br/nfe.aspx?ccm=%InscMunic%&nf=%NumeroNFSe%&cod=%CodVerif%
HomLinkURL=https://nfe.prefeitura.sp.gov.br/nfe.aspx?ccm=%InscMunic%&nf=%NumeroNFSe%&cod=%CodVerif%
Se minha cidade não for atendida, o que fazer?

Mesmo que não haja informação de provedor atribuída para a sua cidade, a adição da mesma é bem simples.

Basta entrar em contato com a prefeitura questionando qual é o provedor que atende a cidade para emissão de notas de serviço, quais são suas URLs e adicionar estas informações no arquivo ACBrNFSeXServicos.ini. Veja o tópico abaixo para uma explicação do procedimento para realizar essa inclusão é explicado em detalhes.


Recebi os erros "Não informada a URL de Homologação, entre em contato com a prefeitura" e "Serviço não implementado para este provedor". E agora, o que eu faço?

Conforme foi citado anteriormente, não há uma padronização por parte dos provedores na forma como implementam seus web services de emissão de nota de serviço.

Isso significa que nem todos os métodos implementados por um provedor estarão disponíveis para outro. Até mesmo a existência do ambiente de homologação não é uma constante.

Veja o tópico abaixo para uma explicação mais detalhada sobre ambas as mensagens(e mais algumas outras) com sugestões do que pode ser feito caso se deparem com elas.


Quais são as formas de homologar?

Por mais estranho que possa parecer, a falta de uma URL de homologação, nem sempre significa que não é possível fazer testes de emissão e que se tenha de partir direto para produção.

Alguns provedores usam uma informação enviada no XML do RPS para diferenciar o ambiente, enquanto outros possuem método específicos para teste.

Confira o tópico abaixo para uma explicação detalhada das diferentes possíveis formas de se homologar uma nota fiscal de serviço.


É importante entender que mesmo que a princípio as soluções ACBr não atendam a uma cidade específica a adição da mesma é um processo simples de ser efetuado.

Ainda que não haja ambiente de homologação para testar a emissão de notas, existem outras formas de se testar.

FLUXO DE ENVIO

O que é o parâmetro do modo de envio e para que ele serve?

A emissão de uma nota de serviço via web service pode ser feita de maneira síncrona ou assíncrona dependendo de como foi implementado pelo provedor.

O parâmetro modo de envio define para a solução ACBr qual dos dois será utilizado. Uma dica para este caso é fazer uso do parâmetro meAutomatico, para que a própria solução se encarregue de decidir qual é o modo mais apropriado.

Qual é o exemplo de um fluxo de emissão?

Para o envio de forma síncrona o retorno da tentativa de emissão já é o XML da NFSe em caso de sucesso e os erros caso alguma coisa precise ser corrigida.

Para o envio de forma assíncrona, podemos definir em:

Emissão
No retorno da emissão é devolvido um número de protocolo.
Consulta da situação do lote.
É devolvido um número representando a situação atual, sendo: 1 - Protocolo consultado inválido, 2 - Lote em processamento, 3- Lote processado com erros e 4 - Lote processado com sucesso.
Quando a situação for 3 ou 4 é feita a consulta do lote.
Consulta do lote para pegar os erros em caso de falha ou o XML da NFSe em caso de sucesso.
O fluxograma abaixo também demonstra o envio de forma assíncrona.

assincronoNFSe.jpg

E se der TimeOut no meio disso?

Em caso de erro de Time Out, antes de fazer novo envio, correndo risco de uma emissão duplicada, é importante realizar consulta pelo RPS para ter certeza de que a nota foi emitida e o Time Out não ocorreu no retorno.

Erros começando em E, L e X?

Erros iniciados em X são próprios da solução ACBr e geralmente são referentes a validações prévias, alertando sobre informações obrigatórias que não foram preenchidas ou erros internos.

Erros iniciados em L ou E são devolvidos pelo web service do provedor.

É importante levar em consideração essa diferença de fluxo entre os modos de envio quando for implementar sua rotina de emissão de nota.

IMPRESSÃO

Tentei imprimir um XML de RPS e não saiu todas as informações, por que?

A rotina de leitura e impressão esperam receber um XML de NFSe para o seu correto funcionamento. Como o XML do RPS é posteriormente convertido para o da NFSe algumas das tags lidas coincidem em nome e por isso não ocorre erro na rotina, mas como o XML do RPS não tem todas as informações, o impresso também não vai ter.

O leiaute de impressão da solução ACBr é diferente do que vem no site da prefeitura?

O impresso da solução ACBr foi idealizado visando atender ao máximo possível as diversas demandas, no entanto, são mais de 5.000 municípios brasileiros e não a nada que impeça que cada um crie um impresso próprio. Por isso é impossível atender a todas as demandas.

PADRÃO NACIONAL

O que é? Quem deve usar? Quem pode usar?

O Padrão Nacional é uma iniciativa que visa trazer ordem a este ambiente caótico de diversos provedores.

Nele, o ambiente nacional é o responsável único por fornecer um web service de emissão e os XMLs são criados seguindo leiaute único independente da cidade.

Desde o dia 01/09/2023, os prestadores de serviço que são MEI estão obrigados a emitir suas NFSes pelo Padrão Nacional, independente da cidade.

Fora isso, para que um prestador possa emitir utilizando o Padrão Nacional, a administração tributária a qual faz parte precisa ter optado pela completa adesão.

Na "Lista de Municípios Aderentes" encontram se as cidades que aderiram e qual foi o tipo de adesão.

Como emitir nota no Padrão Nacional usando as soluções ACBr?

Para emitir NFSe no Padrão Nacional usando as soluções ACBr, basta configurar a cida
RPS/DPS

O que é RPS e DPS?

A sigla RPS significa Recibo Provisório de Serviço.

Diferente do processo de emissão de outros DFes, onde é gerado o XML do respectivo DFe e o mesmo é enviado para validação e aceitação do web service, na emissão de Nota Fiscal de Serviço(NFSe), é o web service quem gera o XML da NFSe.

Ou seja:

image.png

No caso do Padrão Nacional, é chamado de "Declaração de Prestação de Serviço" (DPS).

E apesar da diferença no nome, sua função e lógica é basicamente a mesma do RPS, ou seja, o prestador gera um XML de DPS, envia o mesmo para a API do Padrão Nacional e em caso de sucesso, o DPS é convertido em NFSe e o XML da mesma é devolvido para o prestador.

Por que não existe quando emito direto pela prefeitura?

O RPS só faz parte do processo de emissão quando o mesmo é feito através de um web service.

Quando a emissão é feita pelo site da prefeitura(quando existe a opção), o RPS é inexistente.

É importante entender que o processo de emissão para NFSe é diferente quando feito através do site da prefeitura e quando feito via web service.

Muitas vezes, são usuários diferentes para o site e para o web service, existindo casos em que mesmo no web service os usuários dos ambientes de homologação e produção são diferentes.

PROVEDORES

O que é um provedor?

Provedor é nome dado as empresas que fornecem o web service com o serviço de emissão de nota para as administrações municipais.

Diferente de outros DFes, a nota de serviço tem sua tributação em nível municipal. Por isso, não há, por exemplo, uma Sefaz para cuidar dos serviços de emissão.

Para se ter uma ideia, já passamos da marca de 130 provedores implementados na solução de emissão de nota de serviço do ACBr.

Leiaute ABRASF e Leiaute do próprio?

Devido ao fato de ser algo a nível municipal, não há uma padronização de leiaute na formação dos arquivos XML de RPS e de NFSe.

O leiaute ABRASF foi uma sugestão de padronização feita pela entidade no início do projeto da Nota de Serviço.

Alguns provedores implementaram seus web services seguindo tal padrão, no entanto, ainda assim existem provedores que apesar de seguir o leiaute, implementaram particularidades próprias.

Há também provedores que não seguiram a sugestão e criaram um leiaute próprio completamente diferente.

Temos provedores em que é possível enviar um lote de até 50 RPS e temos provedores em que o envio é unitário.

É importante lembrar que apesar desta falta de padronização por parte dos provedores no que diz respeito a implementação da emissão de NFSe, as soluções ACBr procuram abstrair ao máximo essas particularidades, simplificando o processo de emissão da melhor forma possível.

HOMOLOGAÇÃO

Como saber se minha cidade é atendida?

Para verificar se sua cidade é atendida basta buscar pela mesma no arquivo ACBrNFSeXServicos.ini que acompanha todas as soluções de emissão de Nota de Serviço do ACBr.

Caso haja informação de provedor atribuída, é possível realizar emissão para a mesma.

Vejam um exemplo:

[3550308]
Nome=Sao Paulo
UF=SP
Provedor=ISSSaoPaulo
ProRecepcionar=https://nfe.prefeitura.sp.gov.br/ws/lotenfe.asmx
ProLinkURL=https://nfe.prefeitura.sp.gov.br/nfe.aspx?ccm=%InscMunic%&nf=%NumeroNFSe%&cod=%CodVerif%
HomLinkURL=https://nfe.prefeitura.sp.gov.br/nfe.aspx?ccm=%InscMunic%&nf=%NumeroNFSe%&cod=%CodVerif%
Se minha cidade não for atendida, o que fazer?

Mesmo que não haja informação de provedor atribuída para a sua cidade, a adição da mesma é bem simples.

Basta entrar em contato com a prefeitura questionando qual é o provedor que atende a cidade para emissão de notas de serviço, quais são suas URLs e adicionar estas informações no arquivo ACBrNFSeXServicos.ini. Veja o tópico abaixo para uma explicação do procedimento para realizar essa inclusão é explicado em detalhes.


Recebi os erros "Não informada a URL de Homologação, entre em contato com a prefeitura" e "Serviço não implementado para este provedor". E agora, o que eu faço?

Conforme foi citado anteriormente, não há uma padronização por parte dos provedores na forma como implementam seus web services de emissão de nota de serviço.

Isso significa que nem todos os métodos implementados por um provedor estarão disponíveis para outro. Até mesmo a existência do ambiente de homologação não é uma constante.

Veja o tópico abaixo para uma explicação mais detalhada sobre ambas as mensagens(e mais algumas outras) com sugestões do que pode ser feito caso se deparem com elas.


Quais são as formas de homologar?

Por mais estranho que possa parecer, a falta de uma URL de homologação, nem sempre significa que não é possível fazer testes de emissão e que se tenha de partir direto para produção.

Alguns provedores usam uma informação enviada no XML do RPS para diferenciar o ambiente, enquanto outros possuem método específicos para teste.

Confira o tópico abaixo para uma explicação detalhada das diferentes possíveis formas de se homologar uma nota fiscal de serviço.


É importante entender que mesmo que a princípio as soluções ACBr não atendam a uma cidade específica a adição da mesma é um processo simples de ser efetuado.

Ainda que não haja ambiente de homologação para testar a emissão de notas, existem outras formas de se testar.

FLUXO DE ENVIO

O que é o parâmetro do modo de envio e para que ele serve?

A emissão de uma nota de serviço via web service pode ser feita de maneira síncrona ou assíncrona dependendo de como foi implementado pelo provedor.

O parâmetro modo de envio define para a solução ACBr qual dos dois será utilizado. Uma dica para este caso é fazer uso do parâmetro meAutomatico, para que a própria solução se encarregue de decidir qual é o modo mais apropriado.

Qual é o exemplo de um fluxo de emissão?

Para o envio de forma síncrona o retorno da tentativa de emissão já é o XML da NFSe em caso de sucesso e os erros caso alguma coisa precise ser corrigida.

Para o envio de forma assíncrona, podemos definir em:

Emissão
No retorno da emissão é devolvido um número de protocolo.
Consulta da situação do lote.
É devolvido um número representando a situação atual, sendo: 1 - Protocolo consultado inválido, 2 - Lote em processamento, 3- Lote processado com erros e 4 - Lote processado com sucesso.
Quando a situação for 3 ou 4 é feita a consulta do lote.
Consulta do lote para pegar os erros em caso de falha ou o XML da NFSe em caso de sucesso.
O fluxograma abaixo também demonstra o envio de forma assíncrona.

assincronoNFSe.jpg

E se der TimeOut no meio disso?

Em caso de erro de Time Out, antes de fazer novo envio, correndo risco de uma emissão duplicada, é importante realizar consulta pelo RPS para ter certeza de que a nota foi emitida e o Time Out não ocorreu no retorno.

Erros começando em E, L e X?

Erros iniciados em X são próprios da solução ACBr e geralmente são referentes a validações prévias, alertando sobre informações obrigatórias que não foram preenchidas ou erros internos.

Erros iniciados em L ou E são devolvidos pelo web service do provedor.

É importante levar em consideração essa diferença de fluxo entre os modos de envio quando for implementar sua rotina de emissão de nota.

IMPRESSÃO

Tentei imprimir um XML de RPS e não saiu todas as informações, por que?

A rotina de leitura e impressão esperam receber um XML de NFSe para o seu correto funcionamento. Como o XML do RPS é posteriormente convertido para o da NFSe algumas das tags lidas coincidem em nome e por isso não ocorre erro na rotina, mas como o XML do RPS não tem todas as informações, o impresso também não vai ter.

O leiaute de impressão da solução ACBr é diferente do que vem no site da prefeitura?

O impresso da solução ACBr foi idealizado visando atender ao máximo possível as diversas demandas, no entanto, são mais de 5.000 municípios brasileiros e não a nada que impeça que cada um crie um impresso próprio. Por isso é impossível atender a todas as demandas.

PADRÃO NACIONAL

O que é? Quem deve usar? Quem pode usar?

O Padrão Nacional é uma iniciativa que visa trazer ordem a este ambiente caótico de diversos provedores.

Nele, o ambiente nacional é o responsável único por fornecer um web service de emissão e os XMLs são criados seguindo leiaute único independente da cidade.

Desde o dia 01/09/2023, os prestadores de serviço que são MEI estão obrigados a emitir suas NFSes pelo Padrão Nacional, independente da cidade.

Fora isso, para que um prestador possa emitir utilizando o Padrão Nacional, a administração tributária a qual faz parte precisa ter optado pela completa adesão.

Na "Lista de Municípios Aderentes" encontram se as cidades que aderiram e qual foi o tipo de adesão.

Como emitir nota no Padrão Nacional usando as soluções ACBr?

Para emitir NFSe no Padrão Nacional usando as soluções ACBr, basta configurar a cida