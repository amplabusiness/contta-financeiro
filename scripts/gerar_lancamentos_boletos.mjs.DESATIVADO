/**
 * GERAR LAN√áAMENTOS CONT√ÅBEIS DOS BOLETOS PAGOS
 *
 * Este script cria lan√ßamentos cont√°beis INDIVIDUAIS para cada boleto pago,
 * usando os dados da tabela boleto_payments.
 *
 * RESULTADO NO RAZ√ÉO DO BANCO:
 * Ao inv√©s de "LIQ.COBRANCA SIMPLES-COB000009 R$ 20.000", teremos:
 * - Recebimento CLIENTE A: R$ 5.000
 * - Recebimento CLIENTE B: R$ 8.000
 * - Recebimento CLIENTE C: R$ 7.000
 *
 * Cada lan√ßamento fica rastre√°vel ao cliente que pagou.
 */

import { createClient } from '@supabase/supabase-js';
import * as dotenv from 'dotenv';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

dotenv.config({ path: join(__dirname, '..', '.env') });

const supabaseUrl = process.env.VITE_SUPABASE_URL;
const supabaseKey = process.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
  console.error('‚ùå Credenciais Supabase n√£o encontradas no .env');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

// Configura√ß√£o
const CONFIG = {
  // Contas cont√°beis
  CONTA_BANCO_SICREDI_ID: null,
  CONTA_CLIENTES_RECEBER_ID: null,

  // Per√≠odo para processar
  ANO: 2025,
  MES: 2, // Fevereiro

  // Modo de execu√ß√£o
  DRY_RUN: true, // true = apenas simula, false = executa de verdade
};

// Pegar argumentos da linha de comando
const args = process.argv.slice(2);
if (args.includes('--execute')) {
  CONFIG.DRY_RUN = false;
}
if (args.includes('--mes')) {
  const idx = args.indexOf('--mes');
  CONFIG.MES = parseInt(args[idx + 1]) || 2;
}

async function main() {
  console.log('üè¶ GERA√á√ÉO DE LAN√áAMENTOS CONT√ÅBEIS - BOLETOS SICREDI');
  console.log('='.repeat(70));
  console.log(`üìÖ Per√≠odo: ${CONFIG.MES.toString().padStart(2, '0')}/${CONFIG.ANO}`);
  console.log(`üîß Modo: ${CONFIG.DRY_RUN ? 'SIMULA√á√ÉO (dry-run)' : '‚ö†Ô∏è  EXECU√á√ÉO REAL'}`);
  console.log('');

  // 1. Buscar IDs das contas cont√°beis
  await buscarContasContabeis();

  // 2. Buscar boletos pagos no per√≠odo
  const boletos = await buscarBoletosPagos();

  if (boletos.length === 0) {
    console.log('‚ÑπÔ∏è  Nenhum boleto pago encontrado para o per√≠odo.');
    return;
  }

  // 3. Agrupar por cliente para mostrar resumo
  const porCliente = agruparPorCliente(boletos);

  console.log(`\nüìä RESUMO POR CLIENTE:`);
  console.log('‚îÄ'.repeat(90));
  console.log(`${'Cliente'.padEnd(50)} | ${'Boletos'.padStart(7)} | ${'Valor Total'.padStart(15)}`);
  console.log('‚îÄ'.repeat(90));

  let totalGeral = 0;
  for (const [clienteId, info] of Object.entries(porCliente).sort((a, b) => b[1].total - a[1].total)) {
    const nome = info.nome.substring(0, 48).padEnd(50);
    const qtd = info.boletos.length.toString().padStart(7);
    const valor = 'R$ ' + info.total.toLocaleString('pt-BR', { minimumFractionDigits: 2 }).padStart(12);
    console.log(`${nome} | ${qtd} | ${valor}`);
    totalGeral += info.total;
  }

  console.log('‚îÄ'.repeat(90));
  console.log(`${'TOTAL'.padEnd(50)} | ${boletos.length.toString().padStart(7)} | R$ ${totalGeral.toLocaleString('pt-BR', { minimumFractionDigits: 2 }).padStart(12)}`);

  // 4. Criar lan√ßamentos
  if (!CONFIG.DRY_RUN) {
    console.log('\n\nüìù CRIANDO LAN√áAMENTOS CONT√ÅBEIS...');
    console.log('‚îÄ'.repeat(70));
    await criarLancamentos(boletos);
  } else {
    console.log('\n\n‚ö†Ô∏è  MODO SIMULA√á√ÉO - Nenhum dado foi gravado.');
    console.log('   Para executar de verdade, use: node gerar_lancamentos_boletos.mjs --execute');
    console.log(`\n   Seriam criados ${boletos.length} lan√ßamentos individuais.`);
  }
}

async function buscarContasContabeis() {
  console.log('üîç Buscando contas cont√°beis...');

  // Banco Sicredi
  const { data: banco } = await supabase
    .from('chart_of_accounts')
    .select('id, code, name')
    .eq('code', '1.1.1.05')
    .single();

  if (banco) {
    CONFIG.CONTA_BANCO_SICREDI_ID = banco.id;
    console.log(`   ‚úì ${banco.code} - ${banco.name}`);
  } else {
    throw new Error('Conta 1.1.1.05 (Banco Sicredi) n√£o encontrada!');
  }

  // Clientes a Receber
  const { data: clientes } = await supabase
    .from('chart_of_accounts')
    .select('id, code, name')
    .eq('code', '1.1.2.01')
    .single();

  if (clientes) {
    CONFIG.CONTA_CLIENTES_RECEBER_ID = clientes.id;
    console.log(`   ‚úì ${clientes.code} - ${clientes.name}`);
  } else {
    throw new Error('Conta 1.1.2.01 (Clientes a Receber) n√£o encontrada!');
  }
}

async function buscarBoletosPagos() {
  console.log('\nüîç Buscando boletos pagos no per√≠odo...');

  const mesStr = CONFIG.MES.toString().padStart(2, '0');
  const dataInicio = `${CONFIG.ANO}-${mesStr}-01`;
  const dataFim = `${CONFIG.ANO}-${mesStr}-28`;

  const { data, error } = await supabase
    .from('boleto_payments')
    .select(`
      id,
      cob,
      nosso_numero,
      valor_liquidado,
      data_liquidacao,
      data_extrato,
      client_id,
      clients (id, name)
    `)
    .gte('data_liquidacao', dataInicio)
    .lte('data_liquidacao', dataFim)
    .order('data_liquidacao');

  if (error) {
    console.error('‚ùå Erro ao buscar boletos:', error);
    return [];
  }

  console.log(`   ‚úì Encontrados ${data?.length || 0} boletos pagos`);
  return data || [];
}

function agruparPorCliente(boletos) {
  const porCliente = {};

  for (const boleto of boletos) {
    const clienteId = boleto.client_id || 'SEM_CLIENTE';
    const clienteNome = boleto.clients?.name || 'CLIENTE N√ÉO IDENTIFICADO';

    if (!porCliente[clienteId]) {
      porCliente[clienteId] = {
        id: clienteId,
        nome: clienteNome,
        total: 0,
        boletos: []
      };
    }

    porCliente[clienteId].total += parseFloat(boleto.valor_liquidado) || 0;
    porCliente[clienteId].boletos.push(boleto);
  }

  return porCliente;
}

async function criarLancamentos(boletos) {
  let sucesso = 0;
  let erro = 0;

  for (const boleto of boletos) {
    const clienteNome = boleto.clients?.name || 'CLIENTE N√ÉO IDENTIFICADO';
    const valor = parseFloat(boleto.valor_liquidado) || 0;
    const dataLancamento = boleto.data_extrato || boleto.data_liquidacao;

    // Descri√ß√£o do lan√ßamento com nome do cliente
    const descricao = `Recebimento ${clienteNome} - Boleto ${boleto.nosso_numero}`;

    try {
      // Criar entry
      const { data: entry, error: entryError } = await supabase
        .from('accounting_entries')
        .insert({
          entry_date: dataLancamento,
          competence_date: boleto.data_liquidacao,
          description: descricao,
          entry_type: 'recebimento',
          status: 'posted',
          reference_type: 'boleto_payment',
          reference_id: boleto.id,
          source_type: 'boleto_sicredi',
        })
        .select()
        .single();

      if (entryError) {
        console.error(`   ‚ùå ${clienteNome}: ${entryError.message}`);
        erro++;
        continue;
      }

      // Criar linhas (D√©bito Banco, Cr√©dito Clientes a Receber)
      const linhas = [
        {
          entry_id: entry.id,
          account_id: CONFIG.CONTA_BANCO_SICREDI_ID,
          debit: valor,
          credit: 0,
          description: `D - Banco Sicredi`
        },
        {
          entry_id: entry.id,
          account_id: CONFIG.CONTA_CLIENTES_RECEBER_ID,
          debit: 0,
          credit: valor,
          description: `C - Clientes a Receber - ${clienteNome}`
        }
      ];

      const { error: linhasError } = await supabase
        .from('accounting_entry_lines')
        .insert(linhas);

      if (linhasError) {
        console.error(`   ‚ùå Linhas ${clienteNome}: ${linhasError.message}`);
        erro++;
      } else {
        console.log(`   ‚úì ${clienteNome.substring(0, 40).padEnd(40)} R$ ${valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 }).padStart(10)}`);
        sucesso++;
      }
    } catch (e) {
      console.error(`   ‚ùå Exce√ß√£o ${clienteNome}: ${e.message}`);
      erro++;
    }
  }

  console.log('\n' + '‚îÄ'.repeat(70));
  console.log(`‚úÖ Lan√ßamentos criados com sucesso: ${sucesso}`);
  if (erro > 0) {
    console.log(`‚ùå Lan√ßamentos com erro: ${erro}`);
  }
}

// Executar
main().catch(console.error);
